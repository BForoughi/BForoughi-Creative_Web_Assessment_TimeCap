<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <h1>Simple Social App</h1>
        <a href="login">Login</a>
        <a href="logout">Logout</a>
        <a href="register">Register</a>
        <a href="app">Application</a>
    <h4>New post</h4>
    <form action="/newpost" method="POST">
        <label>message</label>
        <input type="text" id="message" name="message">
        <input type="submit" value="post message">
    </form>
    <h4>Recent posts</h4>
    <ul id="recent-posts"></ul>
    <script>
        const recentPosts=document.getElementById('recent-posts')
        
        //const postId = null // - post id from mongo
        
        fetch('/getposts')
            .then(response=>response.json())
            .then(processData)

        function processData(data){
            console.log(data)
            recentPosts.innerHTML=""
            data.posts.forEach(post=>{
                let li=document.createElement('li')
                let btn = document.createElement('button')
                let likes = document.createElement('p')

                // fetch(`/test/${post._id}`, { method: 'POST' });

                li.innerText=`${post.user}: ${post.message} `
                btn.innerText = "❤️"
                likes.innerText = `Likes: ${post.likes}`
                
                li.classList.add('li')
                btn.classList.add('like-btn')
                likes.id = `likes-${post._id}`
                // console.log(post._id)
                recentPosts.appendChild(li)
                li.appendChild(btn)
                li.appendChild(likes)

                btn.addEventListener('click', async()=>{
                    try{
                        //console.log('Click', post._id)
                        //const res = await fetch(`/posts/${postId}/like`)
                        likePost(post._id)
                    } catch(err) {
                        console.log(err)
                    }
                })
            })
        }

        async function likePost(id){
            const res = await fetch(`/getposts/${id}/like`, {method: 'POST'})
            const data = await res.json()
            if(!data.allowed){
                //console.log(data.error)
                let cannotLike = document.createElement('p')
                cannotLike.innerText = "You can't like your own post"
                document.getElementById(`likes-${id}`).appendChild(cannotLike)
                return;   
            }
            
            document.getElementById(`likes-${id}`).innerText = `Likes: ${data.likes}`
        }
    </script>
</body>
</html>